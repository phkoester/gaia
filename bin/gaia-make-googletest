#!/usr/bin/env bash
#
# gaia-make-googletest
#
# Usage: gaia-make-googletest
#

source "$GAIA_DIR/src/main/bash/gaia/init" || exit 2

clean_up() {
  rm -r $1 \
    CMakeCache.txt \
    CMakeFiles/ \
    googletest/generated/
}

set -e

# Go to project

if [[ ! $GAIA_GOOGLETEST_DIR ]]; then
  shell-error -e2 Environment variable \`GAIA_GOOGLETEST_DIR\` not defined
fi
cd "$GAIA_GOOGLETEST_DIR"

# Set environment variables

if [[ $GAIA_CXX_GNU ]]; then
  export CXX=$GAIA_CXX_GNU
else
  export CXX=$(which g++)
fi
export CXXFLAGS="-fPIC -pthread"
export CC=$(dirname $CXX)/gcc
export CFLAGS="-fPIC -pthread"

# Loop through build types

for buildType in debug release; do
  echo "########################################"
  echo "#"
  echo "# Build type: $buildType"
  echo "#"
  echo "# CC      : $CC"
  echo "# CFLAGS  : $CFLAGS"
  echo "# CXX     : $CXX"
  echo "# CXXFLAGS: $CXXFLAGS"
  echo "#"
  echo "########################################"

  # Call CMake and Make

  clean_up -f
  set -x
  cmake -DCMAKE_BUILD_TYPE=${buildType^} .
  make clean
  make -j$(($(nproc) / 2))
  set +x

  # Copy files

  for file in lib/*.a; do
    dest=$(basename $file)
    if [[ $buildType == debug ]]; then
      dest=${dest%.a}-g.a
    fi
    dest=/usr/lib/$dest
    sudo cp -v $file $dest
  done

  clean_up
done

# EOF
