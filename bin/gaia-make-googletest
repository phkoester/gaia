#!/usr/bin/env bash
#
# gaia-make-googletest
#
# Usage: gaia-make-googletest
#

source "$GAIA_DIR/src/main/bash/gaia/init" || exit 2

clean_up() {
  rm -r $1 \
    CMakeCache.txt \
    CMakeFiles/ \
    googletest/generated/
}

set -e

# Go to project

if [[ ! $GAIA_GOOGLETEST_DIR ]]; then
  shell-error -e2 Environment variable \`GAIA_GOOGLETEST_DIR\` not defined
fi
cd "$GAIA_GOOGLETEST_DIR"

# Set `CFLAGS` and `CXXFLAGS`

export CFLAGS="-fPIC -pthread"
export CXXFLAGS="-fPIC -pthread"

# Loop through toolchains

for toolchain in gnu llvm; do
  if [[ $toolchain != gnu && $toolchain != llvm ]]; then
    shell-error -e2 Toolchain must be \`gnu\` or  \`llvm\`
  fi

  # Set `CXX` and `CC`

  if [[ $toolchain == gnu ]]; then
    if [[ $GAIA_CXX_GNU ]]; then
      export CXX=$GAIA_CXX_GNU
    else
      export CXX=$(which g++)
    fi
    export CC=$(dirname $CXX)/gcc
  else
    if [[ $GAIA_CXX_LLVM ]]; then
      export CXX=$GAIA_CXX_LLVM
    else
      export CXX=$(which clang++)
    fi
    export CC=$(dirname $CXX)/clang
  fi

  # Loop through build types

  for buildType in debug release; do
    dir=target/$GAIA_TARGET-$toolchain-$buildType

    echo "########################################"
    echo "#"
    echo "# $dir"
    echo "#"
    echo "# CC      : $CC"
    echo "# CFLAGS  : $CFLAGS"
    echo "# CXX     : $CXX"
    echo "# CXXFLAGS: $CXXFLAGS"
    echo "#"
    echo "########################################"

    set -x

    # Call CMake and Make

    clean_up -f
    cmake -DCMAKE_BUILD_TYPE=${buildType^} .
    make clean
    make -j$(($(nproc) / 2))
    mkdir -p $dir
    cp lib/* $dir/
    clean_up

    set +x
  done
done

# EOF
